// Generated by CoffeeScript 1.9.1
(function() {
  var base, base1, convertToSmartObject, deleteEmptyLayerSets, deleteEmptyLayers, main, rasterize, setup;

  if ((base = String.prototype).startsWith == null) {
    base.startsWith = function(s) {
      return this.slice(0, s.length) === s;
    };
  }

  if ((base1 = String.prototype).endsWith == null) {
    base1.endsWith = function(s) {
      return s === '' || this.slice(-s.length) === s;
    };
  }

  setup = function() {
    preferences.rulerUnits = Units.PIXELS;
    if (app.documents.length === 0) {
      alert('cannot access document');
      return false;
    }
    return true;
  };

  deleteEmptyLayers = function(root) {
    var deleteLayers, i, j, layer, len, len1, ref, results;
    deleteLayers = [];
    ref = root.artLayers;
    for (i = 0, len = ref.length; i < len; i++) {
      layer = ref[i];
      if (!layer.visible || layer.name.startsWith('#')) {
        deleteLayers.push(layer);
      }
    }
    results = [];
    for (j = 0, len1 = deleteLayers.length; j < len1; j++) {
      layer = deleteLayers[j];
      results.push(layer.remove());
    }
    return results;
  };

  deleteEmptyLayerSets = function(root) {
    var deleteLayerSets, i, j, layer, layerSet, len, len1, ref, results;
    deleteLayerSets = [];
    ref = root.layerSets;
    for (i = 0, len = ref.length; i < len; i++) {
      layerSet = ref[i];
      if (!layerSet.visible || layerSet.name.startsWith('#')) {
        deleteLayerSets.push(layerSet);
      }
    }
    results = [];
    for (j = 0, len1 = deleteLayerSets.length; j < len1; j++) {
      layer = deleteLayerSets[j];
      results.push(layer.remove());
    }
    return results;
  };

  convertToSmartObject = function(layer) {
    layer.allLocked = false;
    app.activeDocument.activeLayer = layer;
    return executeAction(app.stringIDToTypeID('newPlacedLayer'), new ActionDescriptor(), DialogModes.NO);
  };

  rasterize = function(root) {
    var after_bounds, before_bounds, fontSize, h_scale, i, j, k, l, layer, layerSet, len, len1, len2, len3, ref, ref1, ref2, ref3, results, text, w_scale;
    deleteEmptyLayers(root);
    deleteEmptyLayerSets(root);
    ref = root.artLayers;
    for (i = 0, len = ref.length; i < len; i++) {
      layer = ref[i];
      if (layer.kind !== LayerKind.TEXT) {
        continue;
      }
      text = layer.textItem;
      fontSize = text.size;
      before_bounds = layer.bounds;
      text.verticalScale = 100.0;
      text.horizontalScale = 100.0;
      text.size = fontSize;
      after_bounds = layer.bounds;
      w_scale = (before_bounds[2] - before_bounds[0]) / (after_bounds[2] - after_bounds[0]);
      h_scale = (before_bounds[3] - before_bounds[1]) / (after_bounds[3] - after_bounds[1]);
      layer.resize(w_scale * 100, h_scale * 100);
      after_bounds = layer.bounds;
      layer.translate(before_bounds[0] - after_bounds[0], before_bounds[1] - after_bounds[1]);
    }
    ref1 = root.artLayers;
    for (j = 0, len1 = ref1.length; j < len1; j++) {
      layer = ref1[j];
      if (layer.kind === LayerKind.TEXT) {
        continue;
      }
      convertToSmartObject(layer);
    }
    ref2 = root.artLayers;
    for (k = 0, len2 = ref2.length; k < len2; k++) {
      layer = ref2[k];
      if (layer.kind === LayerKind.TEXT) {
        continue;
      }
      layer.rasterize(RasterizeType.ENTIRELAYER);
    }
    ref3 = root.layerSets;
    results = [];
    for (l = 0, len3 = ref3.length; l < len3; l++) {
      layerSet = ref3[l];
      results.push(rasterize(layerSet));
    }
    return results;
  };

  main = function() {
    var copiedDoc, docName, docPath;
    docName = activeDocument.name.slice(0, -4) + '.converted.psd';
    docName = docName.replace(/original.converted.psd/g, "psd");
    docPath = app.activeDocument.path;
    copiedDoc = app.activeDocument.duplicate(docName);
    rasterize(copiedDoc);
    return copiedDoc.saveAs(File(docPath + '/' + docName));
  };

  if (setup()) {
    main();
  }

}).call(this);
